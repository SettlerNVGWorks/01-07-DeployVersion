#!/bin/bash

# üîß –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞ 80 –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø–æ—Ä—Ç–∞ 80..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 80
echo -e "${YELLOW}üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 80...${NC}"
sudo netstat -tulpn | grep :80

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx...${NC}"
sudo systemctl stop nginx 2>/dev/null || echo "nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sudo systemctl disable nginx 2>/dev/null || echo "nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º apache –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω  
echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º apache...${NC}"
sudo systemctl stop apache2 2>/dev/null || echo "apache2 –Ω–µ –∑–∞–ø—É—â–µ–Ω"
sudo systemctl disable apache2 2>/dev/null || echo "apache2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 80
echo -e "${YELLOW}‚ö° –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 80...${NC}"
sudo fuser -k 80/tcp 2>/dev/null || echo "–ü–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω"

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω
echo -e "${YELLOW}‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç 80 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω...${NC}"
if sudo netstat -tulpn | grep :80; then
    echo -e "${RED}‚ùå –ü–æ—Ä—Ç 80 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç!${NC}"
    echo -e "${YELLOW}–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: sudo reboot${NC}"
else
    echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω!${NC}"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—à–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã
echo -e "${YELLOW}üê≥ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker-compose down 2>/dev/null || echo "Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"

# –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç –∑–∞–Ω–æ–≤–æ...${NC}"
docker-compose up -d --build --force-recreate

echo -e "${GREEN}üéâ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:${NC}"
echo "docker-compose ps"